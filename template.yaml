AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >-
  Vaxxie!
Parameters:
  Namespace:
    Type: String
  BotName:
    Type: String
    Default: VacccineSearcher
    Description: >-
      Change this to do something that requires replacement of the Bot resource,
      to test it.
  IntentName:
    Type: String
    Default: SearchForVaccine
    Description: >-
      Change this to do something that requires replacement of the Intent
      resource, to test it.
  IntentDescription:
    Type: String
    Default: Intent to order a vaccine search
    Description: >-
      Change this for a non-replacement-required Update to the Intent, for
      testing.
  BotDescription:
    Type: String
    Default: Bot which manages vaccine searches
    Description: 'Change this for a non-replacement-required Update to the Bot, for testing.'
  EnvironmentPrefix:
    Type: String
  VpcSecondOctet:
    Type: String
  AvailabilityZoneAlpha:
    Type: String
    Default: us-east-1a
  AvailabilityZoneBravo:
    Type: String
    Default: us-east-1b
  AvailabilityZoneCharlie:
    Type: String
    Default: us-east-1c
  DomainName:
    Type: String
    Default: test
  AnnouncementChannel:
    Type: String
    Default: C01L4DNQY8K
  BotUserIdEn:
    Type: String
    Default: U01PEHYJ8ET
  BotUserIdEs:
    Type: String
    Default: U01QYKDKPGT
  ElasticsearchInstanceCount:
    Type: Number
    Default: 6
  SlackDomain:
    Type: String
    Default: texasvaccineupdates
Resources:

  SecretForSlackKey:
    Type: AWS::SecretsManager::Secret



  ### SPANISH

  VaccineBotEs:
    Type: 'Custom::LexBot'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-bot-1-0-3-ServiceToken
      name:
        'Fn::Sub': '${Namespace}${BotName}Es'
      abortStatement:
        messages:
          - content: 'Lo siento, pero no puedo entender lo que acaba de decir. La forma principal de utilizarme es preguntar: Encuentrame una vacuna. Si desea saber mas sobre este bot, diríjase a https://github.com/andrew-templeton/vaxxie/blob/master/README-ES.md, o si desea saber mas sobre las Vaccine Updates Texas (Actualizaciones de Vacunas de Texas), vaya aqui! https://www.notion.so/General-FAQ-cdcb7fa2d55c4179bf94efab1665a40c'
            contentType: PlainText
      childDirected: true
      clarificationPrompt:
        maxAttempts: 1
        messages:
          - content: 'Lo siento, pero no puedo entender lo que acaba de decir. La forma principal de utilizarme es preguntar: Encuentrame una vacuna. Si desea saber mas sobre este bot, dirijase a https://github.com/andrew-templeton/vaxxie/blob/master/README-ES.md, o si desea saber mas sobre las Vaccine Updates Texas (Actualizaciones de Vacunas de Texas), vaya aqui! https://www.notion.so/General-FAQ-cdcb7fa2d55c4179bf94efab1665a40c'
            contentType: PlainText
      description:
        Ref: BotDescription
      idleSessionTTLInSeconds: 300
      intents:
        - intentName:
            Ref: SearchForVaccineEs
          intentVersion: $LATEST
        - intentName:
            Ref: CancelAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: RescheduleAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: TransferAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: LateApptAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: LeftoverAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: SecondAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: DocumentationAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: BookingAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: NoFoundAppointmentsFAQEs
          intentVersion: $LATEST
        - intentName:
            Ref: ListVaccineSearchesEs
          intentVersion: $LATEST
        - intentName:
            Ref: UpdateVaccineSearchEs
          intentVersion: $LATEST
        - intentName:
            Ref: RemoveVaccineSearchEs
          intentVersion: $LATEST
      locale: es-US
      processBehavior: BUILD

  VaccineLambdaLexPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferencePersister
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}SearchForVaccineEs:*"
  SearchForVaccineEs:
    DependsOn:
      - VaccineLambdaLexPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-3-ServiceToken
      name:
        Fn::Sub: "${Namespace}SearchForVaccineEs"
      confirmationPrompt:
        maxAttempts: 1
        messages:
          - content: Deberia comenzar a buscar citas cerca {Zipcode}, dentro {Distance} millas?
            contentType: PlainText
      description:
        Ref: IntentDescription
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferencePersister
              - Arn
      rejectionStatement:
        messages:
          - content: 'Esta bien, no voy a buscar esto'
            contentType: PlainText
          - content: 'Cancele su busqueda.'
            contentType: PlainText
      sampleUtterances:
        - añadir una nueva búsqueda
        - buscar en otra parte
        - buscar en otro lugar
        - buscar en una nueva zona
        - dónde puedo obtener una vacuna dentro {Distance} millas
        - encontrar otra vacuna
        - encontrar una nueva vacuna para mi
        - encontrar una vacuna en una nueva zona
        - encontrar una vacuna en {Zipcode}
        - encuentra citas dentro {Distance} millas de {Zipcode}
        - encuentrame una vacuna
        - necesito encontrar una vacuna de dos dosis dentro {Distance} millas de código postal {Zipcode}
        - necesito encontrar una vacuna dentro {Distance} millas de código postal {Zipcode}
        - por favor ayúdame a encontrar una cita
        - por favor ayúdame a encontrar una vacuna
        - quiero establecer una nueva búsqueda
        - quiero mirar en otro sitio
        - quiero una cita
      slots:
        - name: Distance
          description: The distance in miles to allow notifications
          priority: 1
          sampleUtterances:
            - dentro de {Distance}
            - dentro de {Distance} por favor
            - no más de {Distance}
            - no más de {Distance} millas
            - podría viajar hasta {Distance}
            - podría viajar hasta {Distance} millas
            - puedo ir {Distance} millas
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: A que distancia esta bien para obtener una vacuna, en millas?
                contentType: PlainText
              - content: Que tan lejos esta dispuesto a viajar, en millas, a una cita?
                contentType: PlainText
              - content: Cuanto mayor sea el area que esta dispuesto a ir, mejor. Cuantas millas deberia buscar?
                contentType: PlainText
        - name: Zipcode
          description: The zip code of the search origin
          priority: 2
          sampleUtterances:
            - buscar en {Zipcode}
            - cerca del codigo {Zipcode}
            - comenzar búsqueda en {Zipcode}
            - código postal {Zipcode}
            - mi código postal es {Zipcode}
            - vivo en {Zipcode}
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: Cual es el codigo postal de que le gustaria que empiece su busqueda?
                contentType: PlainText
              - content: Cual es su codigo postal?
                contentType: PlainText

  SearchEditLexPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferenceUpdater
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}UpdateVaccineSearchEs:*"
  UpdateVaccineSearchEs:
    DependsOn:
      - SearchEditLexPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}UpdateVaccineSearchEs"
      confirmationPrompt:
        maxAttempts: 1
        messages:
          - content: Debo reemplazar numero de busqueda {Searchnumber} para las citas cerca {Zipcode}, dentro de {Distance} millas?
            contentType: PlainText
      description: Allow the user to update an existing search
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferenceUpdater
              - Arn
      rejectionStatement:
        messages:
          - content: esta bien, no actualizare su busqueda.
            contentType: PlainText
          - content: Cancele su cambio a la busqueda.
            contentType: PlainText
      sampleUtterances:
        - actualiza de la búsqueda a la que {Distance} desde mi {Zipcode}
        - actualiza de la búsqueda a la que {Distance} millas de {Zipcode}
        - actualiza de la búsqueda a {Distance} millas
        - actualiza de la búsqueda {Searchnumber} sea {Distance} desde mi {Zipcode}
        - actualiza de mi búsqueda
        - actualiza la búsqueda a estar en {Zipcode}
        - actualización de la búsqueda a estar cerca {Zipcode}
        - actualización de la búsqueda {Searchnumber} que sea {Distance} millas de {Zipcode}
        - altera mi búsqueda para estar cerca {Zipcode}
        - altera mi búsqueda para ser {Distance} desde mi {Zipcode}
        - cambia búsqueda {Searchnumber} a {Distance} de {Zipcode}
        - cambia la búsqueda a ser en {Zipcode}
        - cambia la búsqueda a ser {Searchnumber} {Distance} de {Zipcode}
        - cambia la búsqueda a {Distance} millas
        - cambia la búsqueda {Searchnumber} a {Distance} millas de {Zipcode}
        - cambia la búsqueda {Searchnumber} sea {Distance} desde mi {Zipcode}
        - cambia mi búsqueda
        - cambia mi búsqueda a {Distance} millas de {Zipcode}
        - cambia mi búsqueda para estar cerca {Zipcode}
        - cambia mi búsqueda para estar en {Zipcode}
        - cambia mi búsqueda para ser {Distance} millas
        - cambia mi búsqueda para ser {Distance} millas de {Zipcode}
        - cambia mi búsqueda rápida para que {Distance} desde {Zipcode}
        - mira en otro lugar
      slots:
        - name: Searchnumber
          description: The one-indexed index of the search to edit
          priority: 1
          sampleUtterances:
            - "{Searchnumber} por favor"
            - el {Searchnumber} por favor
            - la {Searchnumber}
            - sustituir {Searchnumber}
            - reemplazar número {Searchnumber} por favor
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: 'Cual de busqueda que desea reemplazar? Cuando la lista de las busquedas aparecen tienen una etiqueta como 1 o 2 al lado de ellos. Usted debe decirme que numero se trata. Si necesita ver los numeros de nuevo, me re-preguntar por su lista de busquedas actuales. Si solo alguna vez me pidio que mirara en un solo lugar, solo decir 1. Gracias!'
                contentType: PlainText
        - name: Distance
          description: The distance in miles to allow notifications
          priority: 2
          sampleUtterances:
            - dentro de {Distance}
            - dentro de {Distance} por favor
            - no más de {Distance}
            - no más de {Distance} millas
            - podría viajar hasta {Distance}
            - podría viajar hasta {Distance} millas
            - puedo ir {Distance} millas
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: A que distancia esta bien para obtener una vacuna, en millas, para la busqueda actualizada?
                contentType: PlainText
              - content: Hasta donde estas dispuesto a viajar, en millas, a una cita, para esta busqueda actualizada?
                contentType: PlainText
              - content: Cuanto mas grande es el area que esta dispuesto a ir, mejor. Cuantas millas deberia buscar esta busqueda actualizada?
                contentType: PlainText
        - name: Zipcode
          description: The zip code of the search origin
          priority: 3
          sampleUtterances:
            - buscar en {Zipcode}
            - cerca del codigo {Zipcode}
            - comenzar búsqueda en {Zipcode}
            - código postal {Zipcode}
            - mi código postal es {Zipcode}
            - vivo en {Zipcode}
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: Cual es el codigo postal que le gustaria que empiece su busqueda actualizada de?
                contentType: PlainText
              - content: Cual es su codigo postal a utilizar para la busqueda actualizada?
                contentType: PlainText

  SearchRemoveLexPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferenceRemover
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}RemoveVaccineSearchEs:*"
  RemoveVaccineSearchEs:
    DependsOn:
      - SearchRemoveLexPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}RemoveVaccineSearchEs"
      confirmationPrompt:
        maxAttempts: 1
        messages:
          - content: Debo quitar numero de busqueda {Searchnumber}?
            contentType: PlainText
      description: Allow the user to remove an existing search
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferenceRemover
              - Arn
      rejectionStatement:
        messages:
          - content: Esta bien, no voy a actualizar su busqueda.
            contentType: PlainText
          - content: Me cancelaron su cambio a su busqueda.
            contentType: PlainText
      sampleUtterances:
        - borrar búsqueda {Searchnumber}
        - borrar una de estas búsquedas
        - deja de buscar
        - detener mi búsqueda
        - eliminar búsqueda {Searchnumber}
        - eliminar mi búsqueda
        - eliminar mi búsqueda {Searchnumber}
        - parar la búsqueda
        - parar la búsqueda en uno de estos lugares
        - por favor borra una búsqueda
        - quiero borrar una de mis búsquedas
        - quiero eliminar una de mis búsquedas
        - quitar una de estas búsquedas
      slots:
        - name: Searchnumber
          description: The one-indexed index of the search to edit
          priority: 1
          sampleUtterances:
            - "{Searchnumber} por favor"
            - el {Searchnumber} por favor
            - la {Searchnumber}
            - reemplazar número {Searchnumber} por favor
            - sustituir {Searchnumber}
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: 'Cual busqueda que desea eliminar? Cuando la lista de las busquedas, que tienen una etiqueta como 1 o 2 al lado de ellos. Usted debe decirme de que numero se trata. Si necesita ver los numeros de nuevo, me re-preguntar a su lista de busquedas actuales. Si solo alguna vez me pidio que mirara en un solo lugar, solo decir 1. Gracias!'
                contentType: PlainText

  SearchListLambdaLexPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferenceLister
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}ListVaccineSearchesEs:*"
  ListVaccineSearchesEs:
    DependsOn:
      - SearchListLambdaLexPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}ListVaccineSearchesEs"
      description: "User indicates intent to inspect the existing searches"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferenceLister
              - Arn
      sampleUtterances:
        - Cuáles son mis búsquedas actuales
        - donde está usted buscando en este momento
        - Qué estás tratando de encontrar
        - Cuál cosas he buscado anteriormente
        - Dónde está buscando ahorita
        - Qué estás buscando en este momento
        - cuál era mi última búsqueda
        - qué estás encontrando en este momento
        - favor de hacer una lista de mis búsquedas
        - mostrar mis búsquedas
        - Muéstrame una lista de mis búsquedas
        - Mostrar lo que estás buscando
        - mostrar todas mis búsquedas
        - mostrar todas las cosas que usted está buscando
        - Dónde estas buscando
        - muéstrame lo que está buscando
        - me muestra todas sus búsquedas, por favor
        - muestra todos los lugares que está buscando para mí
        - donde está usted buscando vacunas para mí
        - Cuáles son mis búsquedas
        - Hágame una lista de todos los lugares que está buscando
        - Lista de mis búsquedas

  CancelAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}CancelAppointmentsFAQEs:*"
  CancelAppointmentsFAQEs:
    DependsOn:
      - CancelAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}CancelAppointmentsFAQEs"
      description: "Allows the user to ask questions about how to cancel appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - alguien sabe cómo cancelar
        - cómo cancelamos una cita
        - cómo canceló ud.
        - cómo puedo cancelar
        - cómo se cancela
        - cómo se canceló
        - enlace para cancelar
        - estoy intentando cancelar
        - estoy tratando de cancelar
        - hay un correo electrónico para cancelar
        - hay un número para cancelar la cita
        - necesito cancelar mi cita
        - no puedo hacer la cita
        - uno de mis vecinos no puede asistir a su cita
  RescheduleAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}RescheduleAppointmentsFAQEs:*"
  RescheduleAppointmentsFAQEs:
    DependsOn:
      - RescheduleAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}RescheduleAppointmentsFAQEs"
      description: "Allows the user to ask questions about how to reschedule appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - cómo puedo cambiar la fecha
        - cómo reprogramar
        - cómo se reprograma
        - se puede reprogramar citas

  TransferAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}TransferAppointmentsFAQEs:*"
  TransferAppointmentsFAQEs:
    DependsOn:
      - TransferAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}TransferAppointmentsFAQEs"
      description: "Allows the user to ask questions about how to transfer appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - cómo se puede transferir una cita a otra persona
        - se puede transferir citas a alguién
        - se puede transferir las citas a un otro
        - son transferibles

  LateApptAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}LateApptAppointmentsFAQEs:*"
  LateApptAppointmentsFAQEs:
    DependsOn:
      - LateApptAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}LateApptAppointmentsFAQEs"
      description: "Allows the user to ask questions about how to transfer appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - creo que voy a perder mi cita
        - les importa si llego tarde
        - llego tarde
        - qué pasa si llego tarde
        - qué pasa si me olvido mi cita
        - se me hace tarde
        - tiene que estar allí a la hora de la cita
        - voy a llegar tarde
        - y si llegas tarde

  LeftoverAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}LeftoverAppointmentsFAQEs:*"
  LeftoverAppointmentsFAQEs:
    DependsOn:
      - LeftoverAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}LeftoverAppointmentsFAQEs"
      description: "Allows the user to ask questions about how to transfer appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - hay alguna dosis extra
        - hay algunas vacunas adicionales
        - hay dosis sobrantes
        - hay más dosis sobrantes
        - hay más vacunas sobrantes
        - hay restos de vacunas
        - hay una vacunas que sobraron
        - hay unas doses que queden
        - hay unas sobrantes
        - hay unas vacunas que sobraron
        - hay vacunas adicionales
        - hay vacunas que sobran
        - hay vacunas sobrantes
        - que pasará si hay más restos de vacunas
        - que pasará si hay vacunas sobrantes
        - que sucede cuando unas personas no asisten a sus citas
        - qué pasa si hay más dosis sobrantes
        - qué pasa si hay más vacunas que sobren
        - qué pasa si hay vacunas sobrantes

  SecondAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}SecondAppointmentsFAQEs:*"
  SecondAppointmentsFAQEs:
    DependsOn:
      - SecondAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}SecondAppointmentsFAQEs"
      description: "Allows the user to ask questions about how to get second appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - cuando se la segunda dosis programadas
        - cuando se programan segundo vacunas
        - cuando se programen segunda dosis
        - cuándo son programadas las segundas citas
        - cómo reservar la segunda dosis
        - cómo reservar una segunda cita
        - cómo reservar una segunda dosis
        - cómo reservar una segunda vacuna
        - dónde puedo encontrar una segunda cita
        - dónde puedo encontrar una segunda dosis
        - dónde puedo encontrar una segunda vacuna
        - encontrar una seguna vacuna
        - encontrar una segunda cita
        - encontrar una segunda dosis
        - encontrar una segunda vacuna
        - es la segunda esquema de vacunación programada durante la primera cita
        - horario segunda cita
        - la segunda dosis está programada durante la primera cita
        - las citas para la segunda dosis son programadas durante la primera cita
        - las segundas vacunas son programadas durante la primera cita
        - programar la segunda dosis
        - programar la segunda vacuna
        - programar la vacuna segunda
        - programar una segunda cita
        - programar una segunda dosis
        - programar una segunda oportunidad
        - programar una segunda vacuna

  DocumentationAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}DocumentationAppointmentsFAQEs:*"
  DocumentationAppointmentsFAQEs:
    DependsOn:
      - DocumentationAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}DocumentationAppointmentsFAQEs"
      description: "Allows the user to ask questions about what documentation to bring to appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - cómo puedo demostrar que soy elegible
        - hay algo papeleo que debo llevar
        - hay que llenar formularios
        - necesita su id
        - necesita su identificación
        - no he recibido un correo electrónico
        - no recibi un correo electrónico
        - no tengo la página de confirmación
        - que deberia llevar
        - qué documentación piden
        - qué documentos debo llevar
        - qué me necesito para llevar
        - qué prueba de mi estado piden
        - qué pruebas debo llevar
        - qué pruebas piden
        - se requiere papeleo

  BookingAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}BookingAppointmentsFAQEs:*"
  BookingAppointmentsFAQEs:
    DependsOn:
      - BookingAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}BookingAppointmentsFAQEs"
      description: "Allows the user to ask questions about what documentation to have when booking appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - cuál es la información que necesita
        - cuál es la información que necesita cuando me reservar una cita
        - cuál es la información que necesita para que pueda registrarse para obtener una cita
        - cuál es la información que necesita para que puedo reservar una cita
        - cuál información es requirida cuando reservo una cita
        - cuál información necesitan para que pueda registrarse para obtener una cita
        - cuál información requiren para reservar una cita
        - qué información necesitas
        - qué información requieren
        - qué información se necesita cuando me reserva una cita
        - qué información se necesita para que pueda registrarse para obtener una cita
        - qué información se necesita para que pueda reservar una cita

  NoFoundAppointmentsFAQLambdaPermissionEs:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}NoFoundAppointmentsFAQEs:*"
  NoFoundAppointmentsFAQEs:
    DependsOn:
      - NoFoundAppointmentsFAQLambdaPermissionEs
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}NoFoundAppointmentsFAQEs"
      description: "Allows the user to ask questions about where the heck are the appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - a qué hora presenten nuevas dosis
        - a qué hora presenten nuevas ranuras
        - a qué hora suele bajar de nuevas citas
        - a qué hora suele bajar de vacunas
        - cualquier posibilidad de abrir puntos para mañana
        - cualquier posibilidad de abrir ranuras para mañana
        - cualquier posibilidad de apertura de las vacunas para mañana
        - cuál es el tiempo en que generalmente presenten nueva disponibilidad
        - cuándo habrá más dosis
        - cuándo habrá más nombramientos
        - cuándo habrá más ranuras
        - cuándo habrá más vacunas
        - hay alguna cita disponible
        - hay alguna dosis disponibles
        - hay alguna ranuras disponibles
        - hay alguna vacuna disponible
        - hay cualquier posibilidad de abrir las citas para mañana
        - hay cualquier posibilidad de apertura de las dosis para mañana
        - sabe cuándo será mayor disponibilidad
        - sabe cuándo será más dosis
        - sabe cuándo será más ranuras
        - sabe cuándo será más vacunas

  #ENGLISH

  VaccineLambdaLexPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferencePersister
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}SearchForVaccine:*"
  SearchForVaccine:
    DependsOn:
      - VaccineLambdaLexPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-3-ServiceToken
      name:
        Fn::Sub: "${Namespace}${IntentName}"
      confirmationPrompt:
        maxAttempts: 1
        messages:
          - content: >-
              Should I begin searching for appointments near {Zipcode}, within {Distance} miles?
            contentType: PlainText
      description:
        Ref: IntentDescription
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferencePersister
              - Arn
      rejectionStatement:
        messages:
          - content: 'Okay, I won''t search for this.'
            contentType: PlainText
          - content: I canceled your search.
            contentType: PlainText
      sampleUtterances:
        - Find me a vaccine
        - Where can I get a vaccine within {Distance}
        - Find appointments within {Distance} miles of {Zipcode}
        - I want a vaccine
        - Please help me find an appointment
        - Please help me find a vaccine
        - I want an appointment
        - Find a vaccine in {Zipcode}
        - I need to find a two dose vaccine within {Distance} miles of zip code {Zipcode}
        - I need to find a vaccine within {Distance} miles of zip code {Zipcode}
        - find another vaccine
        - add another search
        - look in another place
        - search in a new area
        - find a vaccine in a new area
        - find me a new vaccine
        - i want to set another search up
        - I want to look somewhere else
        - look somewhere else
      slots:
        - name: Distance
          description: The distance in miles to allow notifications
          priority: 1
          sampleUtterances:
            - No more than {Distance}
            - No more than {Distance} miles
            - I could go up to {Distance} miles
            - I could go up to {Distance}
            - I can drive {Distance} miles
            - Within {Distance}
            - Within {Distance} please
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: How far away is okay to get a vaccine, in miles?
                contentType: PlainText
              - content: How far are you willing to travel, in miles, to an appointment?
                contentType: PlainText
              - content: The larger the area you're willing to go, the better. How many miles should I search?
                contentType: PlainText
        - name: Zipcode
          description: The zip code of the search origin
          priority: 2
          sampleUtterances:
            - Zip code {Zipcode}
            - My zip code is {Zipcode}
            - I live in {Zipcode}
            - Start search in {Zipcode}
            - Look in {Zipcode}
            - Near {Zipcode}
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: What is the zip code you would like me to start your search from?
                contentType: PlainText
              - content: What is your zip code?
                contentType: PlainText

  SearchEditLexPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferenceUpdater
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}UpdateVaccineSearch:*"
  UpdateVaccineSearch:
    DependsOn:
      - SearchEditLexPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}UpdateVaccineSearch"
      confirmationPrompt:
        maxAttempts: 1
        messages:
          - content: Should I replace search number {Searchnumber} for appointments near {Zipcode}, within {Distance} miles?
            contentType: PlainText
      description: Allow the user to update an existing search
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferenceUpdater
              - Arn
      rejectionStatement:
        messages:
          - content: 'Okay, I won''t update your search.'
            contentType: PlainText
          - content: I canceled your change to your search.
            contentType: PlainText
      sampleUtterances:
        - Change my search
        - update my search
        - look in a different place
        - change my search to be {Distance} miles from {Zipcode}
        - change my search to be {Distance} mi from {Zipcode}
        - update my search to be {Distance} miles from {Zipcode}
        - alter my search to be {Distance} miles from {Zipcode}
        - update my search to be {Distance} mi from {Zipcode}
        - alter my search to be {Distance} mi from {Zipcode}
        - Change my search to be {Distance} mi
        - Update my search to be {Distance} mi
        - Alter my search to be {Distance} mi
        - Change my search to be in {Zipcode}
        - alter my search to be in {Zipcode}
        - update my search to be in {Zipcode}
        - Change my search to be near {Zipcode}
        - alter my search to be near {Zipcode}
        - update my search to be near {Zipcode}
        - change search {Searchnumber} to be {Distance} miles from {Zipcode}
        - change search {Searchnumber} to be {Distance} mi from {Zipcode}
        - update search {Searchnumber} to be {Distance} miles from {Zipcode}
        - alter search {Searchnumber} to be {Distance} miles from {Zipcode}
        - update search {Searchnumber} to be {Distance} mi from {Zipcode}
        - alter search {Searchnumber} to be {Distance} mi from {Zipcode}

      slots:
        - name: Searchnumber
          description: The one-indexed index of the search to edit
          priority: 1
          sampleUtterances:
            - Replace number {Searchnumber} please
            - Replace {Searchnumber}
            - "{Searchnumber} please"
            - the {Searchnumber}
            - the {Searchnumber} please
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: 'Which search do you want to replace? When you list the searches, they have a label like 1 or 2 next to them. You should tell me which number this is. If you need to see the numbers again, re-ask me to list your current searches. If you only ever asked me to look in one place, just say 1. Thanks!'
                contentType: PlainText
        - name: Distance
          description: The distance in miles to allow notifications
          priority: 2
          sampleUtterances:
            - No more than {Distance}
            - No more than {Distance} miles
            - I could go up to {Distance} miles
            - I could go up to {Distance}
            - I can drive {Distance} miles
            - Within {Distance}
            - Within {Distance} please
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: How far away is okay to get a vaccine, in miles, for the updated search?
                contentType: PlainText
              - content: How far are you willing to travel, in miles, to an appointment, for this updated search?
                contentType: PlainText
              - content: The larger the area you're willing to go, the better. How many miles should I search for this updated search?
                contentType: PlainText
        - name: Zipcode
          description: The zip code of the search origin
          priority: 3
          sampleUtterances:
            - Zip code {Zipcode}
            - My zip code is {Zipcode}
            - I live in {Zipcode}
            - Start search in {Zipcode}
            - Look in {Zipcode}
            - Near {Zipcode}
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: What is the zip code you would like me to start your updated search from?
                contentType: PlainText
              - content: What is your zip code to use for the updated search?
                contentType: PlainText


  SearchRemoveLexPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferenceRemover
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}RemoveVaccineSearch:*"
  RemoveVaccineSearch:
    DependsOn:
      - SearchRemoveLexPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}RemoveVaccineSearch"
      confirmationPrompt:
        maxAttempts: 1
        messages:
          - content: Should I remove search number {Searchnumber}?
            contentType: PlainText
      description: Allow the user to remove an existing search
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferenceRemover
              - Arn
      rejectionStatement:
        messages:
          - content: 'Okay, I won''t update your search.'
            contentType: PlainText
          - content: I canceled your change to your search.
            contentType: PlainText
      sampleUtterances:
        - remove search {Searchnumber}
        - remove my search {Searchnumber}
        - delete search {Searchnumber}
        - delete my search {Searchnumber}
        - remove my search
        - stop looking
        - stop looking for me
        - stop my search
        - stop searching
        - delete my search
        - remove one of these searches
        - delete one of these searches
        - I want to remove one of my searches
        - I want to delete one of my searches
        - please remove a search
        - stop searching in one of these places
      slots:
        - name: Searchnumber
          description: The one-indexed index of the search to edit
          priority: 1
          sampleUtterances:
            - remove number {Searchnumber} please
            - remove {Searchnumber}
            - "{Searchnumber} please"
            - the {Searchnumber}
            - the {Searchnumber} please
          slotConstraint: Required
          slotType: AMAZON.NUMBER
          valueElicitationPrompt:
            maxAttempts: 1
            messages:
              - content: 'Which search do you want to remove? When you list the searches, they have a label like 1 or 2 next to them. You should tell me which number this is. If you need to see the numbers again, re-ask me to list your current searches. If you only ever asked me to look in one place, just say 1. Thanks!'
                contentType: PlainText

  SearchListLambdaLexPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserPreferenceLister
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}ListVaccineSearches:*"
  ListVaccineSearches:
    DependsOn:
      - SearchListLambdaLexPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}ListVaccineSearches"
      description: "User indicates intent to inspect the existing searches"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserPreferenceLister
              - Arn
      sampleUtterances:
        - what are my current searches
        - where are you looking right now
        - what are you trying to find
        - what have I searched for before
        - where are you searching right now
        - what are you looking for right now
        - what was my last search
        - what are you finding right now
        - list my searches
        - show my searches
        - list searches
        - show what you're looking for
        - show all my searches
        - show all things you're searching for
        - where are you looking
        - show me what you're looking for
        - show me all your searches
        - show me all the places you're searching for me
        - where are you looking for vaccines for me
        - what are my searches
        - list all the places you're looking
        - show searches

  CancelAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}CancelAppointmentsFAQ:*"
  CancelAppointmentsFAQ:
    DependsOn:
      - CancelAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}CancelAppointmentsFAQ"
      description: "Allows the user to ask questions about how to cancel appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - How can I cancel
        - I can't make the appointment
        - I can't make the appt
        - how do I cancel
        - how did you cancel
        - one of my neighbors can't make it
        - How do we cancel an appointment
        - I'm trying to cancel
        - I need to cancel my appt
        - link to cancel
        - Is there a number to cancel
        - Is there a email to cancel
        - Does anyone know how to cancel
        - trying to cancel
        - How did you cancel it

  RescheduleAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}RescheduleAppointmentsFAQ:*"
  RescheduleAppointmentsFAQ:
    DependsOn:
      - RescheduleAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}RescheduleAppointmentsFAQ"
      description: "Allows the user to ask questions about how to reschedule appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - Can you reschedule appointments
        - How do I reschedule
        - How do you reschedule
        - How can I reschedule

  TransferAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}TransferAppointmentsFAQ:*"
  TransferAppointmentsFAQ:
    DependsOn:
      - TransferAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}TransferAppointmentsFAQ"
      description: "Allows the user to ask questions about how to transfer appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - Are they transferable
        - How does one transfer an appointment to someone else
        - Can you transfer appts to someone
        - Can you transfer appointments to someone

  LateApptAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}LateApptAppointmentsFAQ:*"
  LateApptAppointmentsFAQ:
    DependsOn:
      - LateApptAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}LateApptAppointmentsFAQ"
      description: "Allows the user to ask questions about how to transfer appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - do you have to be there at the appointment time
        - what if you're late
        - What if I'm running late
        - I'm running late
        - I'm going to be late
        - What if I miss my appointment
        - I am late
        - I think I am going to miss my appointment
        - Do they care if you're late


  LeftoverAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}LeftoverAppointmentsFAQ:*"
  LeftoverAppointmentsFAQ:
    DependsOn:
      - LeftoverAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}LeftoverAppointmentsFAQ"
      description: "Allows the user to ask questions about how to transfer appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - Are there leftover vaccines
        - What if there are leftover vaccines
        - Are there any extra vaccines
        - What if there are more vaccines leftover
        - what happens when there are no shows
        - any vaccines left
        - any more vaccines left over
        - are there any left over
        - Are there leftover doses
        - What if there are leftover doses
        - Are there any extra doses
        - What if there are more doses leftover
        - any doses left
        - any more doses left over
        - Are there leftover shots
        - What if there are leftover shots
        - Are there any extra shots
        - What if there are more shots leftover
        - any shots left
        - any more shots left over


  SecondAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}SecondAppointmentsFAQ:*"
  SecondAppointmentsFAQ:
    DependsOn:
      - SecondAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}SecondAppointmentsFAQ"
      description: "Allows the user to ask questions about how to get second appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - Are second appointments scheduled during first dose appt
        - Are second doses scheduled during first dose appt
        - Are second shots scheduled during first dose appt
        - Are second vaccines scheduled during first dose appt
        - find a second appointment
        - find a second dose
        - find a second shot
        - find a second vaccine
        - how do you book a second appointment
        - how do you book a second dose
        - how do you book a second shot
        - how do you book a second vaccine
        - schedule a second appointment
        - schedule a second dose
        - schedule a second shot
        - schedule a second vaccine
        - schedule second appointment
        - schedule second dose
        - schedule second shot
        - schedule second vaccine
        - when are second appointments scheduled
        - when are second doses scheduled
        - when are second shots scheduled
        - when are second vaccines scheduled
        - where can I find a second appointment
        - where can I find a second dose
        - where can I find a second shot
        - where can I find a second vaccine

  DocumentationAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}DocumentationAppointmentsFAQ:*"
  DocumentationAppointmentsFAQ:
    DependsOn:
      - DocumentationAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}DocumentationAppointmentsFAQ"
      description: "Allows the user to ask questions about what documentation to bring to appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - I didn't receive an email
        - I don't have the confirmation page
        - are there any forms to fill out
        - did not receive a email
        - do you need your ID
        - do you need your identification
        - how to I prove I am eligible
        - is there any paperwork I need to take
        - is there paperwork required
        - what documentation do they ask for
        - what documents should I bring
        - what proof do they ask for
        - what proof of my status to they ask for
        - what proof should I bring
        - what should I bring
        - what do I need to bring


  BookingAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}BookingAppointmentsFAQ:*"
  BookingAppointmentsFAQ:
    DependsOn:
      - BookingAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}BookingAppointmentsFAQ"
      description: "Allows the user to ask questions about what documentation to have when booking appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - what info do they require
        - what info do they require so I can book an appointment
        - what info do they require so I can sign up for an appointment
        - what info do they require when I book an appointment
        - what information do you need
        - what information do you need so I can book an appointment
        - what information do you need so I can sign up for an appointment
        - what information do you need when I book an appointment
        - what's the info you need
        - what's the info you need so I can book an appointment
        - what's the info you need so I can sign up for an appointment
        - what's the info you need when I book an appointment

  NoFoundAppointmentsFAQLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: UserQuestionFAQAnswerer
      Principal: lex.amazonaws.com
      SourceArn:
        Fn::Sub: "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:intent:${Namespace}NoFoundAppointmentsFAQ:*"
  NoFoundAppointmentsFAQ:
    DependsOn:
      - NoFoundAppointmentsFAQLambdaPermission
    Type: 'Custom::LexIntent'
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-intent-1-0-4-ServiceToken
      name:
        Fn::Sub: "${Namespace}NoFoundAppointmentsFAQ"
      description: "Allows the user to ask questions about where the heck are the appointments"
      fulfillmentActivity:
        type: CodeHook
        codeHook:
          messageVersion: '1.0'
          uri:
            Fn::GetAtt:
              - UserQuestionFAQAnswerer
              - Arn
      sampleUtterances:
        - any chance of appointments opening up for tomorrow
        - any chance of doses opening up for tomorrow
        - any chance of slots opening up for tomorrow
        - any chance of spots opening up for tomorrow
        - any chance of vaccines opening up for tomorrow
        - do you know when will be more availability
        - do you know when will be more doses
        - do you know when will be more slots
        - do you know when will be more vaccines
        - is there any appointment available
        - is there any doses available
        - is there any slots available
        - is there any vaccines available
        - what time do they usually drop appointments
        - what time do they usually drop availability
        - what time do they usually drop doses
        - what time do they usually drop slots
        - what time do they usually drop vaccines
        - when will there be more appointments
        - when will there be more doses
        - when will there be more slots
        - when will there be more vaccines



  VaccineBot:
    Type: 'Custom::LexBot'
    DependsOn:
      - SearchForVaccine
    Properties:
      ServiceToken:
        'Fn::ImportValue': cfn-lex-bot-1-0-3-ServiceToken
      name:
        'Fn::Sub': '${Namespace}${BotName}'
      abortStatement:
        messages:
          - content: 'I am sorry, but I cannot understand what you just said. The main way to use me is to ask: Find me a vaccine. If you want to know more about this bot, head to https://github.com/andrew-templeton/vaxxie/blob/master/README.md, or if you want to know more about Texas Vaccine Updates, go here! https://www.notion.so/General-FAQ-cdcb7fa2d55c4179bf94efab1665a40c'
            contentType: PlainText
      childDirected: true
      clarificationPrompt:
        maxAttempts: 1
        messages:
          - content: 'I am sorry, but I cannot understand what you just said. The main way to use me is to ask: Find me a vaccine. If you want to know more about this bot, head to https://github.com/andrew-templeton/vaxxie/blob/master/README.md, or if you want to know more about Texas Vaccine Updates, go here! https://www.notion.so/General-FAQ-cdcb7fa2d55c4179bf94efab1665a40c'
            contentType: PlainText
      description:
        Ref: BotDescription
      idleSessionTTLInSeconds: 300
      intents:
        - intentName:
            Ref: SearchForVaccine
          intentVersion: $LATEST
        - intentName:
            Ref: CancelAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: RescheduleAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: TransferAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: LateApptAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: LeftoverAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: SecondAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: DocumentationAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: BookingAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: NoFoundAppointmentsFAQ
          intentVersion: $LATEST
        - intentName:
            Ref: ListVaccineSearches
          intentVersion: $LATEST
        - intentName:
            Ref: UpdateVaccineSearch
          intentVersion: $LATEST
        - intentName:
            Ref: RemoveVaccineSearch
          intentVersion: $LATEST
      locale: en-US
      processBehavior: BUILD
  UserPreferencePersister:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: fulfillment.addSearch
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PreferenceTable
      Environment:
        Variables:
          PREFERENCES_TABLE:
            Ref: PreferenceTable
  UserPreferenceUpdater:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: fulfillment.updateSearch
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PreferenceTable
      Environment:
        Variables:
          PREFERENCES_TABLE:
            Ref: PreferenceTable
  UserPreferenceRemover:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: fulfillment.removeSearch
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PreferenceTable
      Environment:
        Variables:
          PREFERENCES_TABLE:
            Ref: PreferenceTable
  UserPreferenceLister:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: fulfillment.listSearches
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PreferenceTable
      Environment:
        Variables:
          PREFERENCES_TABLE:
            Ref: PreferenceTable
  UserQuestionFAQAnswerer:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: fulfillment.faqs
      MemorySize: 128
      Timeout: 300
      Environment:
        Variables:
          NAMESPACE:
            Ref: Namespace
  ExternalCrawlerEnpoint:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: crawlers.external
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: SlotsTable
      Environment:
        Variables:
          SLOTS_TABLE:
            Ref: SlotsTable
      Events:
        PutSlots:
          Type: Api
          Properties:
            Method: PUT
            Path: /slots/{provider}/{utime}
            Auth:
              ApiKeyRequired: true
  ChannelwideGeoBlanket:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: channels.createGeoBlanket
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PreferenceTable
      Environment:
        Variables:
          SLOTS_TABLE:
            Ref: PreferenceTable
      Events:
        PutSlots:
          Type: Api
          Properties:
            Method: PUT
            Path: /blanket/{channelId}/{lang}
            Auth:
              ApiKeyRequired: true
  SeedEsIndex:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: seed.es
      MemorySize: 128
      Timeout: 300
      Environment:
        Variables:
          ES_DOMAIN_ENDPOINT:
            Fn::GetAtt:
              - ElasticsearchDomain
              - DomainEndpoint
          SLOTS_TABLE:
            Ref: SlotsTable
          PREFERENCES_TABLE:
            Ref: PreferenceTable
          PREFERENCES_INDEX: preferences
          SLOTS_INDEX: slots
      VpcConfig:
        SecurityGroupIds:
          - Ref: ElasticsearchAccessorGroup
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
  PingCheckEs:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: seed.pingEs
      MemorySize: 128
      Timeout: 300
      Environment:
        Variables:
          ES_DOMAIN_ENDPOINT:
            Fn::GetAtt:
              - ElasticsearchDomain
              - DomainEndpoint
      VpcConfig:
        SecurityGroupIds:
          - Ref: ElasticsearchAccessorGroup
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
  ExecuteOnEs:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: seed.execute
      MemorySize: 128
      Timeout: 300
      Environment:
        Variables:
          ES_DOMAIN_ENDPOINT:
            Fn::GetAtt:
              - ElasticsearchDomain
              - DomainEndpoint
      VpcConfig:
        SecurityGroupIds:
          - Ref: ElasticsearchAccessorGroup
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
  SlotGeoSearchQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 930
      RedrivePolicy:
        Fn::Sub: '{"deadLetterTargetArn": "${SlotGeoSearchQueueDLQ.Arn}", "maxReceiveCount": 1}'
  SlotGeoSearchQueueDLQ:
    Type: AWS::SQS::Queue
  NotificationsQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 35
      RedrivePolicy:
        Fn::Sub: '{"deadLetterTargetArn": "${NotificationsQueueDLQ.Arn}", "maxReceiveCount": 1}'
  NotificationsQueueDLQ:
    Type: AWS::SQS::Queue
  SlotGeoSearchStreamHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: streamers.slotGeosearch
      MemorySize: 128
      Timeout: 900
      Policies:
        - SQSSendMessagePolicy:
            QueueName:
              Fn::GetAtt:
                - NotificationsQueue
                - QueueName
        - SQSPollerPolicy:
            QueueName:
              Fn::GetAtt:
                - SlotGeoSearchQueue
                - QueueName
      Environment:
        Variables:
          ES_DOMAIN_ENDPOINT:
            Fn::GetAtt:
              - ElasticsearchDomain
              - DomainEndpoint
          PREFERENCES_INDEX: preferences
          SLOTS_INDEX: slots
          NOTIFICATION_QUEUE_URL:
            Ref: NotificationsQueue
          HARD_SHUTOFF: "false"
      VpcConfig:
        SecurityGroupIds:
          - Ref: ElasticsearchAccessorGroup
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
      ReservedConcurrentExecutions: 15
      Events:
        HandleSlotGeoSearchQueue:
          Type: SQS
          Properties:
            Enabled: true
            BatchSize: 1
            Queue:
              Fn::GetAtt:
                - SlotGeoSearchQueue
                - Arn
  SlotStreamHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: streamers.slots
      MemorySize: 128
      Timeout: 900
      Policies:
        - SQSSendMessagePolicy:
            QueueName:
              Fn::GetAtt:
                - SlotGeoSearchQueue
                - QueueName
        - Version: '2012-10-17'
          Statement:
            - Effect: "Allow"
              Action:
                - "dynamodb:DescribeStream"
                - "dynamodb:GetRecords"
                - "dynamodb:GetShardIterator"
              Resource:
                - Fn::GetAtt: SlotsTable.StreamArn
            - Effect: "Allow"
              Action:
                - "dynamodb:ListStreams"
              Resource:
                - Fn::Sub: "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${SlotsTable}/stream/*"
      Environment:
        Variables:
          ES_DOMAIN_ENDPOINT:
            Fn::GetAtt:
              - ElasticsearchDomain
              - DomainEndpoint
          SLOTS_INDEX: slots
          SLOT_GEOSEARCH_QUEUE_URL:
            Ref: SlotGeoSearchQueue
          HARD_SHUTOFF: "false"
      VpcConfig:
        SecurityGroupIds:
          - Ref: ElasticsearchAccessorGroup
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
      Events:
        HandleNewSlots:
          Type: DynamoDB
          Properties:
            BatchSize: 10
            Enabled: true
            StartingPosition: LATEST
            Stream:
              Fn::GetAtt:
                - SlotsTable
                - StreamArn
  PreferenceStreamHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: streamers.preferences
      MemorySize: 256
      Timeout: 300
      Environment:
        Variables:
          ES_DOMAIN_ENDPOINT:
            Fn::GetAtt:
              - ElasticsearchDomain
              - DomainEndpoint
          SLOTS_TABLE:
            Ref: SlotsTable
          PREFERENCES_TABLE:
            Ref: PreferenceTable
          PREFERENCES_INDEX: preferences
          SLOTS_INDEX: slots
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PreferenceTable
        - Version: '2012-10-17'
          Statement:
            - Effect: "Allow"
              Action:
                - "dynamodb:DescribeStream"
                - "dynamodb:GetRecords"
                - "dynamodb:GetShardIterator"
              Resource:
                - Fn::GetAtt: PreferenceTable.StreamArn
            - Effect: "Allow"
              Action:
                - "dynamodb:ListStreams"
              Resource:
                - Fn::Sub: "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PreferenceTable}/stream/*"
      Events:
        HandleNewSlots:
          Type: DynamoDB
          Properties:
            BatchSize: 1000
            Enabled: true
            StartingPosition: LATEST
            Stream:
              Fn::GetAtt:
                - PreferenceTable
                - StreamArn
      VpcConfig:
        SecurityGroupIds:
          - Ref: ElasticsearchAccessorGroup
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
  NotificationsStreamHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: streamers.slideIntoDms
      MemorySize: 256
      Timeout: 30
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: "*"
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn:
              Ref: SecretForSlackKey
        - SQSPollerPolicy:
            QueueName:
              Fn::GetAtt:
                - NotificationsQueue
                - QueueName
      Environment:
        Variables:
          SLACK_SECRET:
            Ref: SecretForSlackKey
          BOT_USER_ID_EN:
            Ref: BotUserIdEn
          BOT_USER_ID_ES:
            Ref: BotUserIdEs
          BOT_GROUP_IDENTIFIER:
            Fn::Sub: "${Namespace}${BotName}"
      Events:
        HandleNotifications:
          Type: SQS
          Properties:
            Enabled: true
            Queue:
              Fn::GetAtt:
                - NotificationsQueue
                - Arn

  AnnounceThyselfHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: announce.thyself
      MemorySize: 128
      Timeout: 300
      Policies:
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn:
              Ref: SecretForSlackKey
      Environment:
        Variables:
          SLACK_DOMAIN:
            Ref: SlackDomain
          ANNOUNCEMENT_CHANNEL:
            Ref: AnnouncementChannel
          SLACK_SECRET:
            Ref: SecretForSlackKey
          BOT_USER_ID_EN:
            Ref: BotUserIdEn
          BOT_USER_ID_ES:
            Ref: BotUserIdEs
      # Events:
      #   AnnounceEverySixHours:
      #     Type: Schedule
      #     Properties:
      #       Enabled: true
      #       Schedule: rate(6 hours)

  VaccineSpotter:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: crawlers.vaccinespotter
      MemorySize: 1024
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: SlotsTable
      Environment:
        Variables:
          SLOTS_TABLE:
            Ref: SlotsTable
      # Events:
      #   VaccineSpotter:
      #     Type: Schedule
      #     Properties:
      #       Enabled: true
      #       Schedule: rate(7 minutes)
  HebCrawler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Runtime: nodejs12.x
      Handler: crawlers.heb
      MemorySize: 128
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: SlotsTable
      Environment:
        Variables:
          SLOTS_TABLE:
            Ref: SlotsTable
      # Events:
      #   HebCollector:
      #     Type: Schedule
      #     Properties:
      #       Enabled: true
      #       Schedule: rate(7 minutes)
  SlotsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      StreamSpecification:
        StreamViewType: NEW_IMAGE
  PreferenceTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      StreamSpecification:
        StreamViewType: NEW_IMAGE



  ### Authorization key(s)
  ExternalCrawlerApiUsagePlan:
    DependsOn:
      - ServerlessRestApi
      - ServerlessRestApiProdStage
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      ApiStages:
        - ApiId:
            Ref: ServerlessRestApi
          Stage: Prod

  ExternalCrawlerApiUsagePlanAssociationToApiKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId:
        Ref: ExternalCrawlerApiKeyJames
      KeyType: API_KEY
      UsagePlanId:
        Ref: ExternalCrawlerApiUsagePlan


  ExternalCrawlerApiKeyJames:
    Type: AWS::ApiGateway::ApiKey
    DependsOn:
      - ServerlessRestApi
      - ServerlessRestApiProdStage
    Properties:
      Description:
        Fn::Sub: 'Base key for traffic manager ${AWS::StackName}'
      Enabled: true
      StageKeys:
        - RestApiId:
            Ref: ServerlessRestApi
          StageName: Prod


  ExternalCrawlerApiUsagePlanAssociationToApiKeyS:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId:
        Ref: ExternalCrawlerApiKeyS
      KeyType: API_KEY
      UsagePlanId:
        Ref: ExternalCrawlerApiUsagePlan
  ExternalCrawlerApiKeyS:
    Type: AWS::ApiGateway::ApiKey
    DependsOn:
      - ServerlessRestApi
      - ServerlessRestApiProdStage
    Properties:
      Description:
        Fn::Sub: 'Base key for traffic manager ${AWS::StackName}'
      Enabled: true
      StageKeys:
        - RestApiId:
            Ref: ServerlessRestApi
          StageName: Prod

  ####################
  # Building the VPC #
  ####################

  ### EIPS
  GatewayAllocationAlpha:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  GatewayAllocationBravo:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  GatewayAllocationCharlie:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  ### VPC Basic Setup
  Vpc:
    Properties:
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.0.0/16
      EnableDnsHostnames: 'true'
      EnableDnsSupport: 'true'
      InstanceTenancy: default
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-VPC"
    Type: AWS::EC2::VPC
  InternetGateway:
    DependsOn:
    - Vpc
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-InternetGateway"
    Type: AWS::EC2::InternetGateway
  InternetGatewayAttachment:
    DependsOn:
    - Vpc
    - InternetGateway
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::VPCGatewayAttachment

  ### Subnetting
  PrivateSubnetAlpha:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAlpha
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.0.0/24
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-Subnet-Private-Alpha"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::Subnet
  PrivateSubnetBravo:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBravo
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.1.0/24
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-Subnet-Private-Bravo"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::Subnet
  PrivateSubnetCharlie:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCharlie
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.2.0/24
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-Subnet-Private-Charlie"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::Subnet
  PublicSubnetAlpha:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAlpha
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.3.0/24
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-Subnet-Public-Alpha"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::Subnet
  PublicSubnetBravo:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBravo
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.4.0/24
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-Subnet-Public-Bravo"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::Subnet
  PublicSubnetCharlie:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCharlie
      CidrBlock:
        Fn::Sub: 10.${VpcSecondOctet}.5.0/24
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-Subnet-Public-Charlie"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::Subnet

  ### Generate empty route tables
  RouteTablePrivateAlpha:
    DependsOn:
    - Vpc
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-RTB-Private-Alpha"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::RouteTable
  RouteTablePrivateBravo:
    DependsOn:
    - Vpc
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-RTB-Private-Bravo"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::RouteTable
  RouteTablePrivateCharlie:
    DependsOn:
    - Vpc
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-RTB-Private-Charlie"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::RouteTable
  RouteTablePublicAlpha:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-RTB-Public-Alpha"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::RouteTable
  RouteTablePublicBravo:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-RTB-Public-Bravo"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::RouteTable
  RouteTablePublicCharlie:
    DependsOn:
    - Vpc
    - InternetGatewayAttachment
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-RTB-Public-Charlie"
      VpcId:
        Ref: Vpc
    Type: AWS::EC2::RouteTable

  ### Route public spaces to gateway
  PublicRouteToInternetGatewayAlpha:
    DependsOn:
    - InternetGatewayAttachment
    - RouteTablePublicAlpha
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: RouteTablePublicAlpha
    Type: AWS::EC2::Route
  PublicRouteToInternetGatewayBravo:
    DependsOn:
    - InternetGatewayAttachment
    - RouteTablePublicBravo
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: RouteTablePublicBravo
    Type: AWS::EC2::Route
  PublicRouteToInternetGatewayCharlie:
    DependsOn:
    - InternetGatewayAttachment
    - RouteTablePublicCharlie
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: RouteTablePublicCharlie
    Type: AWS::EC2::Route

  ### Generate NAT gateways
  NatGatewayAlpha:
    DependsOn:
    - PublicSubnetAlpha
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - GatewayAllocationAlpha
          - AllocationId
      SubnetId:
        Ref: PublicSubnetAlpha
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-NAT-Gateway-Alpha"
  NatGatewayBravo:
    DependsOn:
    - PublicSubnetBravo
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - GatewayAllocationBravo
          - AllocationId
      SubnetId:
        Ref: PublicSubnetBravo
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-NAT-Gateway-Bravo"
  NatGatewayCharlie:
    DependsOn:
    - PublicSubnetCharlie
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - GatewayAllocationCharlie
          - AllocationId
      SubnetId:
        Ref: PublicSubnetCharlie
      Tags:
      - Key: Name
        Value:
          Fn::Sub: "${EnvironmentPrefix}-NAT-Gateway-Charlie"

  ### Route private to NAT Gateways
  PrivateRouteToNATGatewayAlpha:
    DependsOn:
    - NatGatewayAlpha
    - RouteTablePrivateAlpha
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NatGatewayAlpha
      RouteTableId:
        Ref: RouteTablePrivateAlpha
    Type: AWS::EC2::Route
  PrivateRouteToNATGatewayBravo:
    DependsOn:
    - NatGatewayBravo
    - RouteTablePrivateBravo
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NatGatewayBravo
      RouteTableId:
        Ref: RouteTablePrivateBravo
    Type: AWS::EC2::Route
  PrivateRouteToNATGatewayCharlie:
    DependsOn:
    - NatGatewayCharlie
    - RouteTablePrivateCharlie
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NatGatewayCharlie
      RouteTableId:
        Ref: RouteTablePrivateCharlie
    Type: AWS::EC2::Route

  ### Bind routing to subnets so no default routing
  PrivateSubnetAlphaRouteTableAssociation:
    DependsOn:
    - RouteTablePrivateAlpha
    - PrivateSubnetAlpha
    Properties:
      RouteTableId:
        Ref: RouteTablePrivateAlpha
      SubnetId:
        Ref: PrivateSubnetAlpha
    Type: AWS::EC2::SubnetRouteTableAssociation
  PrivateSubnetBravoRouteTableAssociation:
    DependsOn:
    - RouteTablePrivateBravo
    - PrivateSubnetBravo
    Properties:
      RouteTableId:
        Ref: RouteTablePrivateBravo
      SubnetId:
        Ref: PrivateSubnetBravo
    Type: AWS::EC2::SubnetRouteTableAssociation
  PrivateSubnetCharlieRouteTableAssociation:
    DependsOn:
    - RouteTablePrivateCharlie
    - PrivateSubnetCharlie
    Properties:
      RouteTableId:
        Ref: RouteTablePrivateCharlie
      SubnetId:
        Ref: PrivateSubnetCharlie
    Type: AWS::EC2::SubnetRouteTableAssociation
  PublicSubnetAlphaRouteTableAssociation:
    DependsOn:
    - RouteTablePublicAlpha
    - PublicSubnetAlpha
    Properties:
      RouteTableId:
        Ref: RouteTablePublicAlpha
      SubnetId:
        Ref: PublicSubnetAlpha
    Type: AWS::EC2::SubnetRouteTableAssociation
  PublicSubnetBravoRouteTableAssociation:
    DependsOn:
    - RouteTablePublicBravo
    - PublicSubnetBravo
    Properties:
      RouteTableId:
        Ref: RouteTablePublicBravo
      SubnetId:
        Ref: PublicSubnetBravo
    Type: AWS::EC2::SubnetRouteTableAssociation
  PublicSubnetCharlieRouteTableAssociation:
    DependsOn:
    - RouteTablePublicCharlie
    - PublicSubnetCharlie
    Properties:
      RouteTableId:
        Ref: RouteTablePublicCharlie
      SubnetId:
        Ref: PublicSubnetCharlie
    Type: AWS::EC2::SubnetRouteTableAssociation

  MainOperationalDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName:
        Fn::Sub: "${Namespace}${BotName}-MainOperationalDashboard"
      DashboardBody:
        Fn::Sub: |
          {
              "widgets": [
                  {
                      "type": "metric",
                      "x": 0,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/Lex", "BotChannelRequestCount", "BotAlias", "BETA", "BotChannelName", "TexasVaccineUpdates", "BotName", "${Namespace}${BotName}", "Source", "SLACK", { "label": "Invocations" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": false,
                          "region": "${AWS::Region}",
                          "period": 60,
                          "stat": "Sum",
                          "title": "Overall Chat Invocations",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 12,
                      "y": 0,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/Lex", "RuntimeRequestCount", "BotAlias", "BETA", "Operation", "PostText", "BotName", "${Namespace}${BotName}", { "label": "Intent Hits" } ],
                              [ ".", "MissedUtteranceCount", ".", ".", ".", ".", ".", ".", { "label": "Intent Misses" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": true,
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "title": "Missed Versus Hit Intents Over Time",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 6,
                      "y": 0,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/Lex", "RuntimeRequestCount", "BotAlias", "BETA", "Operation", "PostText", "BotName", "${Namespace}${BotName}", { "label": "Intent Hits" } ],
                              [ ".", "MissedUtteranceCount", ".", ".", ".", ".", ".", ".", { "label": "Intent Misses" } ]
                          ],
                          "view": "pie",
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "setPeriodToTimeRange": true,
                          "title": "Fraction Of NLP Misses"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 6,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/Lambda", "Errors", "FunctionName", "${AWS::StackName}-${ExternalCrawlerEnpoint}", { "label": "ExternalCrawlerEnpoint" } ],
                              [ "...", "${HebCrawler}", { "label": "HebCrawler" } ],
                              [ "...", "${PingCheckEs}", { "label": "PingCheckEs" } ],
                              [ "...", "${PreferenceStreamHandler}", { "label": "PreferenceStreamHandler" } ],
                              [ "...", "${SeedEsIndex}", { "label": "SeedEsIndex" } ],
                              [ "...", "${SlotStreamHandler}", { "label": "SlotStreamHandler" } ],
                              [ "...", "${UserPreferenceLister}", { "label": "UserPreferenceLister" } ],
                              [ "...", "${UserPreferencePersister}", { "label": "UserPreferencePersister" } ],
                              [ "...", "${UserPreferenceRemover}", { "label": "UserPreferenceRemover" } ],
                              [ "...", "${UserPreferenceUpdater}", { "label": "UserPreferenceUpdater" } ],
                              [ "...", "${UserQuestionFAQAnswerer}", { "label": "UserQuestionFAQAnswerer" } ],
                              [ "...", "${VaccineSpotter}", { "label": "VaccineSpotter" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": true,
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "title": "Lambda Internal Errors",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 0,
                      "y": 6,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/Lambda", "Invocations", "FunctionName", "${AWS::StackName}-${ExternalCrawlerEnpoint}", { "label": "ExternalCrawlerEnpoint" } ],
                              [ "...", "${HebCrawler}", { "label": "HebCrawler" } ],
                              [ "...", "${PingCheckEs}", { "label": "PingCheckEs" } ],
                              [ "...", "${PreferenceStreamHandler}", { "label": "PreferenceStreamHandler" } ],
                              [ "...", "${SeedEsIndex}", { "label": "SeedEsIndex" } ],
                              [ "...", "${SlotStreamHandler}", { "label": "SlotStreamHandler" } ],
                              [ "...", "${UserPreferenceLister}", { "label": "UserPreferenceLister" } ],
                              [ "...", "${UserPreferencePersister}", { "label": "UserPreferencePersister" } ],
                              [ "...", "${UserPreferenceRemover}", { "label": "UserPreferenceRemover" } ],
                              [ "...", "${UserPreferenceUpdater}", { "label": "UserPreferenceUpdater" } ],
                              [ "...", "${UserQuestionFAQAnswerer}", { "label": "UserQuestionFAQAnswerer" } ],
                              [ "...", "${VaccineSpotter}", { "label": "VaccineSpotter" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": true,
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "title": "System Invocations",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 18,
                      "y": 0,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/Lambda", "Invocations", "FunctionName", "${AWS::StackName}-${UserPreferenceLister}", { "label": "List Searches" } ],
                              [ "...", "${UserPreferencePersister}", { "label": "Add A Search" } ],
                              [ "...", "${UserPreferenceRemover}", { "label": "Remove A Search" } ],
                              [ "...", "${UserPreferenceUpdater}", { "label": "Update A Search" } ],
                              [ "...", "${UserQuestionFAQAnswerer}", { "label": "FAQ" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": true,
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "title": "Chat Invocations",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 12,
                      "y": 6,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/ES", "CPUUtilization", "DomainName", "${DomainName}", "ClientId", "${AWS::AccountId}" ],
                              [ ".", "SearchRate", ".", ".", ".", ".", { "yAxis": "right" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": false,
                          "region": "${AWS::Region}",
                          "stat": "Maximum",
                          "period": 60,
                          "title": "Elasticsearch Demand",
                          "yAxis": {
                              "left": {
                                  "min": 0,
                                  "max": 100
                              },
                              "right": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 18,
                      "y": 6,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                            [ "AWS/SQS", "NumberOfMessagesSent", "QueueName", "${SlotGeoSearchQueue.QueueName}" ],
                            [ ".", "NumberOfMessagesDeleted", ".", "." ],
                            [ ".", "ApproximateNumberOfMessagesVisible", ".", ".", { "yAxis": "right" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": false,
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "yAxis": {
                              "left": {
                                  "min": 0
                              },
                              "right": {
                                "min": 0
                              }
                          },
                          "title": "GeoSearch Queue"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 6,
                      "y": 6,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "AWS/ES", "IndexingLatency", "DomainName", "${DomainName}", "ClientId", "${AWS::AccountId}", { "yAxis": "right", "period": 60 } ],
                              [ ".", "SearchLatency", ".", ".", ".", "." ]
                          ],
                          "view": "timeSeries",
                          "stacked": false,
                          "region": "${AWS::Region}",
                          "stat": "p95",
                          "period": 300,
                          "title": "Elasticsearch Latencies",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              },
                              "right": {
                                  "min": 0
                              }
                          }
                      }
                  },
                  {
                      "type": "metric",
                      "x": 0,
                      "y": 0,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ { "expression": "100*(1-m4/m3)", "label": "Intent Hit Rate", "id": "e1", "region": "${AWS::Region}" } ],
                              [ "AWS/Lambda", "Invocations", "FunctionName", "${UserPreferencePersister}", { "id": "m1", "label": "Searches Added" } ],
                              [ "AWS/Lex", "RuntimeRequestCount", "BotAlias", "BETA", "Operation", "PostText", "BotName", "${Namespace}${BotName}", { "id": "m3", "label": "Messages To Vaxxie" } ],
                              [ ".", "MissedUtteranceCount", ".", ".", ".", ".", ".", ".", { "id": "m4", "visible": false, "label": "Missed Intents" } ],
                              [ "Vaxxie", "NotificationsSent", "BotGroupIdentifier", "${Namespace}${BotName}", { "id": "m2" } ]
                          ],
                          "view": "singleValue",
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "setPeriodToTimeRange": true,
                          "title": "KPIs For Period"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 18,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ { "expression": "100*(1-m2/m3)", "label": "Intent Hit Rate", "id": "e1" } ],
                              [ "AWS/Lambda", "Invocations", "FunctionName", "${UserPreferencePersister}", { "yAxis": "right", "label": "Searches Added", "id": "m1" } ],
                              [ "AWS/Lex", "MissedUtteranceCount", "BotAlias", "BETA", "Operation", "PostText", "BotName", "${Namespace}${BotName}", { "visible": false, "id": "m2" } ],
                              [ ".", "RuntimeRequestCount", ".", ".", ".", ".", ".", ".", { "visible": false, "id": "m3" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": false,
                          "region": "${AWS::Region}",
                          "stat": "Sum",
                          "period": 60,
                          "yAxis": {
                              "left": {
                                  "min": 0,
                                  "max": 100
                              },
                              "right": {
                                  "min": 0
                              }
                          },
                          "title": "Interaction Metrics Over Time"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 12,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "metrics": [
                              [ "Vaxxie", "NotificationsSent", "BotGroupIdentifier", "${Namespace}${BotName}", { "label": "Sent" } ],
                              [ ".", "NotificationsErrored", ".", ".", { "label": "Errored" } ]
                          ],
                          "view": "timeSeries",
                          "stacked": true,
                          "region": "${AWS::Region}",
                          "yAxis": {
                              "left": {
                                  "min": 0
                              }
                          },
                          "stat": "Sum",
                          "period": 60,
                          "title": "Appointment Slot Notifications"
                      }
                  }
              ]
          }





  ElasticsearchDomain:
    Type: AWS::Elasticsearch::Domain
    Properties:
      DomainName:
        Ref: DomainName
      ElasticsearchClusterConfig:
        DedicatedMasterEnabled: "true"
        InstanceCount:
          Ref: ElasticsearchInstanceCount
        ZoneAwarenessEnabled: "true"
        InstanceType: "m5.large.elasticsearch"
        DedicatedMasterType: "m5.large.elasticsearch"
        DedicatedMasterCount: "3"
        ZoneAwarenessConfig:
          AvailabilityZoneCount: 3
      ElasticsearchVersion: "7.9"
      EBSOptions:
        EBSEnabled: true
        VolumeSize: 50
        VolumeType: "gp2"
      SnapshotOptions:
        AutomatedSnapshotStartHour: "0"
      AccessPolicies:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              AWS: "*"
            Action: "es:*"
            Resource:
              Fn::Sub: "arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${DomainName}/*"
      AdvancedOptions:
        rest.action.multi.allow_explicit_index: "true"
      VPCOptions:
        SubnetIds:
          - Ref: PrivateSubnetAlpha
          - Ref: PrivateSubnetBravo
          - Ref: PrivateSubnetCharlie
        SecurityGroupIds:
          - Ref: ElaticsearchSecurityGroupAllowingAccessors


  ElaticsearchSecurityGroupAllowingAccessors:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allows access from the ElasticsearchAccessorGroup
      VpcId:
        Ref: Vpc
      SecurityGroupIngress:
        - FromPort: '443'
          IpProtocol: tcp
          ToPort: '443'
          SourceSecurityGroupId:
            Ref: ElasticsearchAccessorGroup
  ElasticsearchAccessorGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allows access from the ElasticsearchAccessorGroup
      VpcId:
        Ref: Vpc
      SecurityGroupIngress: []
      SecurityGroupEgress:
        - CidrIp: "0.0.0.0/0"
          FromPort: -1
          IpProtocol: -1
          ToPort: -1

Outputs:
  VaccineBotChecksum:
    Description: The checksum of the Lex Bot for this stack.
    Value:
      'Fn::GetAtt':
        - VaccineBot
        - checksum
  VaccineBotVersion:
    Description: The version of the Lex Bot for this stack.
    Value:
      'Fn::GetAtt':
        - VaccineBot
        - version
